# AutoAlarm Project Architecture and Design

## Overview

AutoAlarm is an AWS Lambda-based automation tool designed to dynamically manage CloudWatch alarms for ALBs, EC2
Instances, OpenSearch, SQS, and Target Groups based on instance states and specific tag values. The project uses AWS SDK
for JavaScript v3, the AWS CDK for infrastructure deployment, and is integrated with AWS Lambda and CloudWatch for
automated cloud observability. A key part of AutoAlarm is the reAlarm Lambda function, which is triggered every two
hours to automatically check CloudWatch alarms and reset those in the ALARM state that are not tied to Auto Scaling
actions. This process ensures that alarms re-alert to maintain visibility on resource health and mitigate missed alerts
and failures.

## Features

- **Dynamic Alarm Management**: Automatically creates, updates, and deletes CloudWatch alarms based
  on EC2 instance states and tag changes.
- **CloudWatch Alarm Integration**: Supports creating both static threshold CloudWatch alarms and anomaly detection alarms.
- **Customization Through Tags**: Uses tags to define alarm thresholds and conditions, allowing per-instance
  customization. Tags can be dynamically updated to configure statistics for anomaly detection alarms, thresholds for
  warning and critical static threshold alarms, in addition to evaluation period length and number of periods.
- **Scalable and Extendable**: Designed to handle multiple instances and can be extended to support other AWS resources.

## Architecture

The AutoAlarm project is designed to be deployed with minimal configuration, creating all necessary AWS resources for
full functionality. Upon deployment, the project automatically provisions the following components:

- **IAM Roles and Policies**: Provides the necessary permissions for the Lambda functions to interact with AWS services
  like EC2, CloudWatch, SQS, and more.
- **Lambda Functions**: Core logic for AutoAlarm is handled by AWS Lambda, which manages the creation, updating, and
  deletion of CloudWatch alarms based on resource state and tag changes. AutoAlarm includes a reAlarm function that
  retriggers alarms in the ALARM state every two hours to ensure that alerts are not missed.
- **EventBridge Rules**: AutoAlarm uses Amazon EventBridge to listen for events across various services, such as EC2
  state changes and tag updates. These rules trigger the Lambda function to manage alarms dynamically based on the event
  data. These event triggers are what determine when alarms are created, updated, or deleted.
- **CloudWatch Log Groups**: Log groups are created to capture the logs generated by the Lambda functions, enabling easy
  monitoring and troubleshooting.
- **SQS Queues**: Dead-letter queues (DLQs) are set up using Amazon SQS to capture and manage failed Lambda function
  executions for further investigation and retry.
- **CloudWatch Alarms for Lambda Monitoring**: Alarms are created to monitor the performance and availability of the
  Lambda function itself, ensuring that any issues with alarm management are caught early.

This architecture ensures that AutoAlarm can monitor and manage resources out-of-the-box, including ALBs, EC2 instances,
OpenSearch domains, SQS queues, RDS instances, RDS clusters, Step Functions, and Target Groups. The system is fully
event-driven, dynamically responding to state and tag changes across these resources.

### Special Considerations:

- **Alerting**: If you are not a customer of the TrueMark Enterprise Operations Center, you will need to configure Alarm
  notification routing via SNS or other custom integrations.

## AWS Services Used

### 1. Amazon CloudFront

CloudFront is monitored by AutoAlarm for events related to CloudFront distributions. The Lambda function creates,
updates, or deletes alarms for CloudFront metrics based on events and tags.

### 2. Amazon CloudWatch

Amazon CloudWatch is utilized for monitoring and alerting. CloudWatch alarms are created, updated, or deleted by the
Lambda function to track various metrics such as CPU utilization, memory usage, storage usage, ALB metrics, and Target
Group metrics. CloudWatch Logs are also used to store log data generated by the Lambda function for debugging and
auditing purposes. AutoAlarm also includes a ReAlarm function that runs every two hours to reset alarms in an alarm
state that are not tied to Auto Scaling actions. This helps reduce and mitigate missed alerts and failures by ensuring
that technicians and engineers are kept engaged in ongoing monitoring and alerting.

### 3. Amazon EC2

The main Lambda function responds to state change notifications and tag change events for EC2 instances, creating or
updating alarms based on the instance's state and tags.

### 4. Amazon EventBridge

Amazon EventBridge is used to route events to Lambda functions. Rules are set up to listen for specific events such as
state changes, tag changes, and other resource events. These events trigger the Lambda function to perform the necessary
alarm management actions. Additionally, when using TrueMark's Enterprise Operation Center, EventBridge is monitored for
triggered alarms, eliminating the need to send them to a specific SNS topic.

### 5. Amazon Managed Prometheus (AMP)

AMP is integrated with AutoAlarm to monitor custom metrics for various AWS resources. The Lambda function can create,
update, or delete alert rules within AMP based on specified metric thresholds. This integration allows for detailed,
real-time monitoring of application and infrastructure performance, leveraging Prometheus' powerful query language
(PromQL) to detect anomalies and trigger alerts. AutoAlarm ensures that alert rules are dynamically managed, keeping
monitoring configurations up to date as infrastructure changes.

### 6. Amazon Simple Queue Service (SQS)

Amazon SQS is used as a dead-letter queue for the Lambda function. If the Lambda function fails to process an event,
the event is sent to an SQS queue for further investigation and retry.

### 7. AWS Elastic Load Balancing (ELB) And Target Groups

ELB is monitored by AutoAlarm for events related to Application Load Balancers (ALBs) and Target Groups. The Lambda
function creates, updates, or deletes alarms for ALB metrics and target group metrics based on events and tags. Note that
the supported metrics for Target Groups require that the target group is associated with an ALB.

### 8. AWS Identity and Access Management (IAM)

IAM is used to define roles and policies that grant the necessary permissions to the Lambda function. These roles allow
the function to interact with other AWS services such as CloudWatch, EC2, AMP, SQS, and EventBridge.

### 9. AWS Lambda

AWS Lambda is used to run the main AutoAlarm function, which processes service and tag events in addition to managing
alarms. The Lambda function is responsible for handling the logic to create, update, or delete CloudWatch alarms and
Prometheus rules based on tags and state changes.

### 10. AWS OpenSearch Service (OS)

OS is monitored by AutoAlarm for events related to OpenSearch Service. The Lambda function creates, updates, or deletes
alarms for OS metrics based on events and tags.

### 11. AWS Relational Database Service (RDS)

RDS instances and clusters are monitored by AutoAlarm for various metrics like CPU utilization, database connections,
database load, deadlocks, freeable memory, replica lag, swap usage, and write latency. The Lambda function creates,
updates, or deletes alarms for RDS metrics based on events and tags.

### 12. AWS Route53Resolver

Route53Resolver is monitored by AutoAlarm for events related to Route53Resolver endpoints. The Lambda function creates,
updates, or deletes alarms for Route53Resolver metrics based on events and tags.

### 13. AWS Step Functions

Step Functions are monitored by AutoAlarm for events related to state machine executions. The Lambda function creates,
updates, or deletes alarms for Step Functions metrics like failed executions and timed out executions.

### 14. AWS TransitGateway

TransitGateway is monitored by AutoAlarm for events related to TransitGateway attachments. The Lambda function creates,
updates, or deletes alarms for TransitGateway metrics based on events and tags.

### 15. AWS VPN

VPN is monitored by AutoAlarm for events related to VPN connections. The Lambda function creates, updates, or
deletes alarms for VPN metrics based on events and tags.

## IAM Role and Permissions

The Lambda execution role requires specific permissions to interact with AWS services. These are created when the CDK
project is deployed.:

- **EC2 and CloudWatch**:

    - Actions: `ec2:DescribeInstances`, `ec2:DescribeTags`, `cloudwatch:PutMetricAlarm`, `cloudwatch:DeleteAlarms`, `cloudwatch:DescribeAlarms`, `cloudwatch:SetAlarmState`, `cloudwatch:ListMetrics`
    - Resources: `*`

- **CloudWatch Logs**:

    - Actions: `logs:CreateLogGroup`, `logs:CreateLogStream`, `logs:PutLogEvents`
    - Resources: `*`

- **Elasic Load Balancing**:

    - Actions: `elasticloadbalancing:DescribeLoadBalancers`, `elasticloadbalancing:DescribeTargetGroups`, `elasticloadbalancing:DescribeTags`, `elasticloadbalancing:DescribeTargetHealth`
    - Resources: `*`

- **SQS**:

    - Actions: `sqs:GetQueueAttributes`, `sqs:ListQueues`, `sqs:ListQueueTags`, `sqs:TagQueue`
    - Resources: `*`

- **OpenSearch**:

    - Actions: `es:DescribeElasticsearchDomain`, `es:ListTags`, `es:ListDomainNames`
    - Resources: `*`

- **CloundFront**:

    - Actions: `cloudfront:GetDistribution`, `cloudfront:ListDistributions`, `cloudfront:ListTagsForResource`
    - Resources: `*`

- **TransitGateway**:

    - Actions: `ec2:DescribeTransitGateways`
    - Resources: `*`

- **Route53Resolver**:

    - Actions: `route53resolver:ListResolverEndpoints`, `route53resolver:ListTagsForResource`
    - Resources: `*`

- **VPN**:
    - Actions: `ec2:DescribeVpnConnections`
    - Resources: `*`

### CloudWatch Alarm Overview

Tags are used to customize CloudWatch alarms for various AWS services managed by AutoAlarm. By applying specific tags to
resources such as EC2 instances, ALBs, Target Groups, SQS, and OpenSearch, you can define custom thresholds, evaluation
periods, and other parameters for both static threshold and anomaly detection alarms. The following sections outline the
default configurations and explain how you can modify them using these tags.

### Prometheus Alarms Overview:

Currently, AutoAlarm only supports EC2 prometheus alarms for CPU, Memory, and Storage utilization. These are static
threshold alarms. Anomaly alarms are not supported. To use prometheus functionality a context variable with the
prometheus workspaceID must be set in the CDK deployment like so:

```bash
cdk deploy -c prometheusWorkspaceId='ws-11111111-7e2c-ffff-8009-c9fb233c73bd' AutoAlarm
```

#### Default Values and Behaviors:

By default, anytime an EC2 instance triggers AutoAlarm, if a prometheus workspaceID is set and instance is reporting
to Prometheus, AutoAlarm prefers prometheus and will create prometheus alarms for CPU, Memory, and Storage utilization.

If you explicitly want to use CloudWatch alarms for EC2 instances, you can set the `autoalarm:target` tag to `cloudwatch`
on the instance. Inversely, you can explicitly define `promehteus` as the target however, this is unnecessary as AutoAlarm
prefers and defaults to prometheus is a workspace ID is provided and the instance is reporting to prometheus.

Anytime Prometheus alarms are created, any existing cloudwatch alarms for that instance are deleted.

Prometheus alarms are created from the default configuration values for each default alarm if tags for those alarms are
not set or, values can be defined by setting the appropriate tags on the instance. These tag values are defined below
and are ubiquitous across both cloudwatch alarms and prometheus alarms.

It should be noted, however, while the Prometheus integration uses standard tagging to define alarm thresholds, it does
not support comparison operators beyond `GreaterThanThreshold` or data treatments like Cloudwatch alarms. The default
queries for the Prometheus alarms are as follows:

- CPU Utilization For Linux Instances: `100 - (rate(node_cpu_seconds_total{instance=~"(${PrivateIp}.*|${instanceId})", mode="idle"}[30s]) * 100) > ${threshold}`
- CPU Utilization For Windows Instances: `100 - (rate(windows_cpu_time_total{instance=~"(${PrivateIp}.*|${instanceId})", mode="idle"}[30s]) * 100) > ${threshold}`

- Memory Utilization for Linux Instances: `100 - (node_memory_MemAvailable_bytes{instance=~"(${PrivateIp}.*|${instanceId})"} / node_memory_MemTotal_bytes{instance=~"(${PrivateIp}.*|${instanceId})"} * 100) > ${threshold}`
- Memory Utilization for Windows Instances: `100 - (windows_memory_available_bytes{instance=~"(${PrivateIp}.*|${instanceId})"} / windows_memory_total_bytes{instance=~"(${PrivateIp}.*|${instanceId})"} * 100) > ${threshold}`

- Storage Utilization For Linux Instances: `100 - (node_filesystem_avail_bytes{instance=~"(${PrivateIp}.*|${instanceId})", mountpoint="/"} / node_filesystem_size_bytes{instance=~"(${PrivateIp}.*|${instanceId})", mountpoint="/"} * 100) > ${threshold}`
- Storage Utilization For Windows Instances: `100 - (windows_logical_disk_free_bytes{instance=~"(${PrivateIp}.*|${instanceId})", drive="C:"} / windows_logical_disk_size_bytes{instance=~"(${PrivateIp}.*|${instanceId})", drive="C:"} * 100) > ${threshold}`

AutoAlarm automatically pulls the privateIP Addresses, InstanceIDs and Platform of each instance and populates that
information into each query in addition to pulling the threshold from the default value or the tag values on the instance.

If an instance is explicitly configured for prometheus via tagging, but the instance is not reporting to prometheus,
AutoAlarm will intelligently detect any instance that is not reporting to prometheus and will create cloudwatch alarms as
a fallback.


