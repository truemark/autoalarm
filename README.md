# AutoAlarm Project README

## Overview

AutoAlarm is an AWS Lambda-based automation tool designed to dynamically manage CloudWatch alarms and Prometheus rules for EC2 instances, ALBs, and Target Groups based on instance states and specific tag values. The project uses AWS SDK for JavaScript v3, the AWS CDK for infrastructure deployment, and is integrated with AWS Lambda, CloudWatch, and Prometheus for operational functionality.

## Architecture

The project consists of several key components:

- `MainHandler`: A TypeScript-based Lambda function that handles EC2, CloudWatch, and Prometheus operations.
- `AutoAlarmConstruct`: A CDK construct that sets up the necessary AWS resources and permissions for the Lambda function.
- `MainFunction`: A class extending `ExtendedNodejsFunction` to configure Lambda function specifics.
- `AutoAlarmStack`: The CDK stack that deploys the constructs and manages dependencies.

## Features

- **Dynamic Alarm Management**: Automatically creates, updates, and deletes CloudWatch alarms and Prometheus rules based on EC2 instance states and tag changes.
- **Anomaly Detection Integration**: Supports creating both standard CloudWatch alarms and anomaly detection alarms for specified metrics such as `HostCount`.
- **Customization Through Tags**: Uses tags to define alarm thresholds and conditions, allowing per-instance customization. Tags can be dynamically updated to configure statistics for anomanly detection alarms, thresholds for warning and critical static threshold alarms, in addition to evaluation period length and number of periods.
- **Scalable and Extendable**: Designed to handle multiple instances and can be extended to support other AWS resources.

## AWS Services Used

### 1. Amazon CloudWatch
Amazon CloudWatch is utilized for monitoring and alerting. CloudWatch alarms are created, updated, or deleted by the Lambda function to track various metrics such as CPU utilization, memory usage, storage usage, ALB metrics, and Target Group metrics. CloudWatch Logs are also used to store log data generated by the Lambda function for debugging and auditing purposes.

### 2. Amazon EC2
Amazon EC2 is the primary service monitored by AutoAlarm. The Lambda function responds to state change notifications and tag change events for EC2 instances, creating or updating alarms based on the instance's state and tags.

### 3. Amazon EventBridge
Amazon EventBridge is used to route events to the Lambda function. Rules are set up to listen for specific events such as state changes, tag changes, and other resource events. These events trigger the Lambda function to perform the necessary alarm management actions.

### 4. Amazon Managed Service for Prometheus (AMP)
AMP is used for querying metrics and managing Prometheus rules. The Lambda function can create, update, or delete Prometheus rules in the specified Prometheus workspace based on the instance's metrics and tags. Prometheus metrics are used as an alternative to CloudWatch for monitoring.

### 5. Amazon Simple Queue Service (SQS)
Amazon SQS is used as a dead-letter queue for the Lambda function. If the Lambda function fails to process an event, the event is sent to an SQS queue for further investigation and retry.

### 6. AWS Elastic Load Balancing (ELB) And Target Groups
ELB is monitored by AutoAlarm for events related to Application Load Balancers (ALBs) and Target Groups. The Lambda function creates, updates, or deletes alarms for ALB metrics and target group metrics based on events and tags.

### 7. AWS OpenSearch Service (OS)
OS is monitored by AutoAlarm for events related to OpenSearch Service. The Lambda function creates, updates, or deletes alarms for OS metrics based on events and tags.

### 8. AWS Identity and Access Management (IAM)
IAM is used to define roles and policies that grant the necessary permissions to the Lambda function. These roles allow the function to interact with other AWS services such as CloudWatch, EC2, AMP, SQS, and EventBridge.

### 9. AWS Lambda
AWS Lambda is used to run the main AutoAlarm function, which processes service and tag events in addition to managing alarms. The Lambda function is responsible for handling the logic to create, update, or delete CloudWatch alarms and Prometheus rules based on tags and state changes.


## Usage

The system is event-driven, responding to EC2 state change notifications and tag modification events. To manage alarms and Prometheus rules, ensure your EC2 instances are tagged according to the supported schema defined below.

## Tag Values and Behaviour

### Overview
Tags are used to customize CloudWatch alarms for various AWS services managed by AutoAlarm. By applying specific tags to resources such as EC2 instances, ALBs, Target Groups, SQS, and OpenSearch, you can define custom thresholds, evaluation periods, and other parameters for both static threshold and anomaly detection alarms. The following sections outline the default configurations and explain how you can modify them using these tags.

### Default Values
AutoAlarm comes with predefined default values for various alarms. These defaults are designed to provide general monitoring out-of-the-box. However, it is crucial that any enabled alarms are reviewed to ensure they align with the specific needs of your application and environment.

### Application Load Balancer (ALB)

| Tag                               | Default Value                                          | Enabled By Default | CloudWatch Only |
|-----------------------------------|--------------------------------------------------------|--------------------|-----------------|
| `autoalarm:4xx-count`             | "-/-/60/2/Sum/2/GreaterThanThreshold/ignore"           | No                 | Yes             |
| `autoalarm:4xx-count-anomaly`     | "2/5/300/1/Average/1/GreaterThanUpperThreshold/ignore" | No                 | Yes             | 
| `autoalarm:5xx-count`             | "-/-/60/2/Sum/2/GreaterThanThreshold/ignore"           | No                 | Yes             |
| `autoalarm:5xx-count-anomaly`     | "2/5/300/2/Average/2/GreaterThanUpperThreshold/ignore" | Yes                | Yes             |
| `autoalarm:request-count`         | "-/-/60/2/Sum/2/GreaterThanThreshold/ignore"           | No                 | Yes             |
| `autoalarm:request-count-anomaly` | "3/5/300/2/Average/2/GreaterThanUpperThreshold/ignore" | No                 | Yes             |

### EC2

| Tag                         | Default Value                                          | Enabled By Default | CloudWatch Only                 |
|-----------------------------|--------------------------------------------------------|--------------------|---------------------------------|
| `autoalarm:cpu`             | "95/98/60/5/Maximum/5/GreaterThanThreshold/ignore"     | Yes                | No                              |
| `autoalarm:cpu-anomaly`     | "2/5/60/5/Average/5/GreaterThanUpperThreshold/ignore"  | No                 | Yes                             |
| `autoalarm:memory`          | "95/98/60/10/Maximum/10/GreaterThanThreshold/ignore"   | Yes                | No                              |
| `autoalarm:memory-anomaly`  | "2/5/300/2/Average/2/GreaterThanUpperThreshold/ignore" | No                 | Yes (Requires CloudWatch Agent) |
| `autoalarm:storage`         | "90/95/60/2/Maximum/1/GreaterThanThreshold/ignore"     | Yes                | No                              |
| `autoalarm:storage-anomaly` | "2/3/60/2/Average/1/GreaterThanUpperThreshold/ignore"  | No                 | Yes (Requires CloudWatch Agent) |

### SQS

| Tag                                       | Default Value                                          | Enabled By Default | CloudWatch Only |
|-------------------------------------------|--------------------------------------------------------|--------------------|-----------------|
| `autoalarm:age-of-oldest-message`         | "-/-/300/1/Maximum/1/GreaterThanThreshold/ignore"      | No                 | Yes             |
| `autoalarm:age-of-oldest-message-anomaly` | "-/-/300/1/Average/1/GreaterThanUpperThreshold/ignore" | No                 | Yes             |
| `autoalarm:empty-receives`                | "-/-/300/1/Sum/1/GreaterThanThreshold/ignore"          | No                 | Yes             |
| `autoalarm:empty-receives-anomaly`        | "-/-/300/1/Sum/1/GreaterThanUpperThreshold/ignore"     | No                 | Yes             |
| `autoalarm:messages-deleted`              | "-/-/300/1/Sum/1/GreaterThanThreshold/ignore"          | No                 | Yes             |
| `autoalarm:messages-deleted-anomaly`      | "-/-/300/1/Average/1/GreaterThanUpperThreshold/ignore" | No                 | Yes             |
| `autoalarm:messages-not-visible`          | "-/-/300/1/Maximum/1/GreaterThanThreshold/ignore"      | No                 | Yes             |
| `autoalarm:messages-not-visible-anomaly`  | "-/-/300/1/Average/1/GreaterThanUpperThreshold/ignore" | No                 | Yes             |
| `autoalarm:messages-received`             | "-/-/300/1/Sum/1/GreaterThanThreshold/ignore"          | No                 | Yes             |
| `autoalarm:messages-received-anomaly`     | "-/-/300/1/Average/1/GreaterThanUpperThreshold/ignore" | No                 | Yes             |
| `autoalarm:messages-sent`                 | "-/-/300/1/Sum/1/GreaterThanThreshold/ignore"          | No                 | Yes             |
| `autoalarm:messages-sent-anomaly`         | "1/1/300/1/Average/1/GreaterThanUpperThreshold/ignore" | No                 | Yes             |
| `autoalarm:messages-visible`              | "-/-/300/1/Maximum/1/GreaterThanThreshold/ignore"      | No                 | Yes             |
| `autoalarm:messages-visible-anomaly`      | "-/-/300/1/Average/1/GreaterThanUpperThreshold/ignore" | Yes                | Yes             |
| `autoalarm:sent-message-size`             | "-/-/300/1/Average/1/GreaterThanThreshold/ignore"      | No                 | Yes             |
| `autoalarm:sent-message-size-anomaly`     | "-/-/300/1/Average/1/GreaterThanUpperThreshold/ignore" | No                 | Yes             |

### Target Groups (TG)

| Tag                               | Default Value                                          | Enabled By Default | CloudWatch Only |
|-----------------------------------|--------------------------------------------------------|--------------------|-----------------|
| `autoalarm:4xx-count`             | "-/-/60/2/Sum/1/GreaterThanThreshold/ignore"           | No                 | Yes             |
| `autoalarm:4xx-count-anomaly`     | "-/-/60/2/Average/1/GreaterThanUpperThreshold/ignore"  | No                 | Yes             |
| `autoalarm:5xx-count`             | "-/-/60/2/Sum/1/GreaterThanThreshold/ignore"           | No                 | Yes             |
| `autoalarm:5xx-count-anomaly`     | "3/6/60/2/Average/1/GreaterThanUpperThreshold/ignore"  | Yes                | Yes             |
| `autoalarm:response-time`         | "3/5/60/2/p90/2/GreaterThanThreshold/ignore"           | No                 | Yes             |
| `autoalarm:response-time-anomaly` | "2/5/300/2/Average/2/GreaterThanUpperThreshold/ignore" | No                 | Yes             |
| `autoalarm:unhealthy-host-count`  | "-/1/60/2/Maximum/2/GreaterThanThreshold/ignore"       | Yes                | Yes             |

### OpenSearch

| Tag                                     | Default Value                                          | Enabled By Default | CloudWatch Only |
|-----------------------------------------|--------------------------------------------------------|--------------------|-----------------|
| `autoalarm:4xx-errors`                  | "100/300/300/1/Sum/1/GreaterThanThreshold/ignore"      | No                 | Yes             |
| `autoalarm:4xx-errors-anomaly`          | "-/-/300/1/Average/1/GreaterThanUpperThreshold/ignore" | No                 | Yes             |
| `autoalarm:5xx-errors`                  | "10/50/300/1/Sum/1/GreaterThanThreshold/ignore"        | Yes                | Yes             |
| `autoalarm:5xx-errors-anomaly`          | "-/-/300/1/Average/1/GreaterThanUpperThreshold/ignore" | No                 | Yes             |
| `autoalarm:cpu`                         | "98/98/300/1/Maximum/1/GreaterThanThreshold/ignore"    | Yes                | Yes             |
| `autoalarm:cpu-anomaly`                 | "2/2/300/1/Average/1/GreaterThanUpperThreshold/ignore" | No                 | Yes             |
| `autoalarm:iops-throttle`               | "5/10/300/1/Sum/1/GreaterThanThreshold/ignore"         | Yes                | Yes             |
| `autoalarm:iops-throttle-anomaly`       | "-/-/300/1/Average/1/GreaterThanUpperThreshold/ignore" | No                 | Yes             |
| `autoalarm:jvm-memory`                  | "85/92/300/1/Maximum/1/GreaterThanThreshold/ignore"    | Yes                | Yes             |
| `autoalarm:jvm-memory-anomaly`          | "-/-/300/1/Average/1/GreaterThanUpperThreshold/ignore" | No                 | Yes             |
| `autoalarm:read-latency`                | "0.03/0.08/60/2/Maximum/2/GreaterThanThreshold/ignore" | Yes                | Yes             |
| `autoalarm:read-latency-anomaly`        | "2/6/300/2/Average/2/GreaterThanUpperThreshold/ignore" | No                 | Yes             |
| `autoalarm:search-latency`              | "1/2/300/2/Average/2/GreaterThanThreshold/ignore"      | Yes                | Yes             |
| `autoalarm:search-latency-anomaly`      | "-/-/300/2/Average/2/GreaterThanUpperThreshold/ignore" | Yes                | Yes             |
| `autoalarm:snapshot-failure`            | "-/1/300/1/Sum/1/GreaterThanOrEqualToThreshold/ignore" | Yes                | Yes             |
| `autoalarm:storage`                     | "10000/5000/300/2/Average/2/LessThanThreshold/ignore"  | Yes                | Yes             |
| `autoalarm:storage-anomaly`             | "2/3/300/2/Average/2/GreaterThanUpperThreshold/ignore" | Yes                | Yes             |
| `autoalarm:throughput-throttle`         | "40/60/60/2/Sum/2/GreaterThanThreshold/ignore"         | No                 | Yes             |
| `autoalarm:throughput-throttle-anomaly` | "3/5/300/1/Average/1/GreaterThanUpperThreshold/ignore" | No                 | Yes             |
| `autoalarm:write-latency`               | "84/100/60/2/Maximum/2/GreaterThanThreshold/ignore"    | Yes                | Yes             |
| `autoalarm:write-latency-anomaly`       | "-/-/60/2/Average/2/GreaterThanUpperThreshold/ignore"  | No                 | Yes             |
| `autoalarm:yellow-cluster`              | "-/1/300/1/Maximum/1/GreaterThanThreshold/ignore"      | Yes                | Yes             |
| `autoalarm:red-cluster`                 | "-/1/60/1/Maximum/1/GreaterThanThreshold/ignore"       | Yes                | Yes             |

### Customizing Alarms with Tags

When setting up non-default alarms with tags, you must provide at least the first two values (warning and critical thresholds) for the tag to function correctly. If these thresholds are not supplied, the alarm will not be created unless defaults are defined.

**Example:**

`autoalarm:cpu=80/95/60/5/Maximum/5/GreaterThanThreshold/ignore`
- *`80`* is the warning threshold
- *`95`* is the critical threshold

### Static Threshold vs Anomaly Detection Alarms

**Static Threshold Alarms**:
- Triggered when a metric crosses a fixed value.
- Suitable for metrics with consistent ranges.

**Anomaly Detection Alarms**:
- Triggered when a metric deviates from a dynamic range based on historical data.
- Best for metrics with variable patterns.

### Supported Statistics
You can use the following statistics for alarms.
- SampleCount
- Average
- Sum
- Minimum
- Maximum
- Percentiles (e.g., `p90`)

### Comparison Operators
**Static Threshold Alarms**
- `GreaterThanOrEqualToThreshold`
- `GreaterThanThreshold`
- `LessThanThreshold`
- `LessThanOrEqualToThreshold`

**Anomaly Detection Alarms**
- `GreaterThanUpperThreshold`
- `LessThanLowerOrGreaterThanUpperThreshold`
- `LessThanLowerThreshold`

### Default Alarm Behavior

Tags are organized alarm types, service and metrics. Anomaly detection alarms are created by default while static threshold cloudwatch alarms are created based on tags. Staic threshold tags have default values in the case that an incorrect value is parsed in the warning or critical fields but are otherwise not set if those fields are empty or the tag does not exist. Additionally, Anomaly alarms are configured to alert on data above the 90th percentile historical data over 2 evaluations periods at 60 seconds each. The default percentile, period duration and number of periods can also be configured with tag values

## EventBridge Rules

The project configures AWS EventBridge to route specific events to the AutoAlarm Lambda function. The following rules are set up to trigger the Lambda function based on state changes and tag modifications:

| Rule Name          | Event Source             | Detail Type                            | Detail                                                                                                         | Description                                 |
|--------------------|--------------------------|----------------------------------------|----------------------------------------------------------------------------------------------------------------|---------------------------------------------|
| TagRule            | aws.tag                  | Tag Change on Resource                 | service: ['ec2', 'ecs', 'rds']<br>resource-type: ['instance']<br>changed-tag-keys: [various keys]              | Routes tag events to AutoAlarm              |
| Ec2Rule            | aws.ec2                  | EC2 Instance State-change Notification | state: ['running', 'terminated']                                                                               | Routes ec2 instance events to AutoAlarm     |
| AlbTagRule         | aws.tag                  | Tag Change on Resource                 | service: ['elasticloadbalancing']<br>resource-type: ['loadbalancer']<br>changed-tag-keys: [various keys]       | Routes ALB tag events to AutoAlarm          |
| AlbRule            | aws.elasticloadbalancing | Alb creation or deletion               | eventSource: ['elasticloadbalancing.amazonaws.com']<br>eventName: ['CreateLoadBalancer', 'DeleteLoadBalancer'] | Routes ALB events to AutoAlarm              |
| TargetGroupTagRule | aws.tag                  | Tag Change on Resource                 | service: ['elasticloadbalancing']<br>resource-type: ['targetgroup']<br>changed-tag-keys: [various keys]        | Routes Target Group tag events to AutoAlarm |
| TargetGroupRule    | aws.elasticloadbalancing | Target Group Creation or Deletion      | eventSource: ['elasticloadbalancing.amazonaws.com']<br>eventName: ['CreateTargetGroup', 'DeleteTargetGroup']   | Routes Target Group events to AutoAlarm     |
| SqsRule            | aws.sqs                  | Queue Creation, Tag Change or Deletion | eventSource: ['sqs.amazonaws.com']<br>eventName: ['CreateQueue', 'DeleteQueue', 'TagQueue', 'UntagQueue']      | Routes SQS events to AutoAlarm              |

## Prometheus Rules (in Progress-Not Yet Implemented)

### Supported Metrics for Prometheus Rules

- **CPU Utilization**
- **Memory Utilization**
- **Storage Utilization**

## IAM Role and Permissions

The Lambda execution role requires specific permissions to interact with AWS services:

- **Prometheus**:
  - Actions: `aps:QueryMetrics`, `aps:ListRuleGroupsNamespaces`, `aps:DescribeRuleGroupsNamespace`, `aps:CreateRuleGroupsNamespace`, `aps:PutRuleGroupsNamespace`, `aps:DeleteRuleGroupsNamespace`
  - Resources: `arn:aws:aps:${region}:${accountId}:workspace/${prometheusWorkspaceId}`, `arn:aws:aps:${region}:${accountId}:*/${prometheusWorkspaceId}/*`

- **EC2 and CloudWatch**:
  - Actions: `ec2:DescribeInstances`, `ec2:DescribeTags`, `cloudwatch:PutMetricAlarm`, `cloudwatch:DeleteAlarms`, `cloudwatch:DescribeAlarms`, `cloudwatch:ListMetrics`
  - Resources: `*`

- **CloudWatch Logs**:
  - Actions: `logs:CreateLogGroup`, `logs:CreateLogStream`, `logs:PutLogEvents`
  - Resources: `*`

- **Elasic Load Balancing**:
  - Actions: `elasticloadbalancing:DescribeLoadBalancers`, `elasticloadbalancing:DescribeTargetGroups`, `elasticloadbalancing:DescribeTags`, `elasticloadbalancing:DescribeTargetHealth`
  - Resources: `*`

- **SQS**:
  - Actions: `sqs:GetQueueAttributes`, `sqs:ListQueues`, `sqs:ListQueueTags`, `sqs:TagQueue`
  - Resources: `*`

- **OpenSearch**:
  - Actions: `es:DescribeElasticsearchDomain`, `es:ListTags`, `es:ListDomainNames`
  - Resources: `*`

## Limitations

- Currently supports only EC2 instances, ALBs, Target Groups, SQS and Opensearch. Extension to other services like ECS or RDS would require modifications to the Lambda function and CDK setup.
- Tag-based configuration may not be suitable for all use cases. Customization options are limited to the supported tags.
- Some alarms and rules are created by default even without tags, such as CPU utilization alarms, and can only be modified with the use of tags. Otherwise, they will be created with default values.

Please refer to the code files provided for more detailed information on the implementation and usage of the AutoAlarm system.

